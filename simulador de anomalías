// ==UserScript==
// @id              iitc_plugin_anomaly_simulator
// @name           IITC Plugin: Anomaly Simulator
// @category       Misc
// @version        1.1
// @description    Simula anomalías para práctica, compatible con Draw Tools y Bookmarks
// @author         ShadowVcL
// @downloadURL    https://github.com/ShadowVcL/anomaly-simulator-plus-V1.user.js
// @updateURL      https://your-update-url-here
// @match          *://intel.ingress.com/*
// @match          *://intel-x.ingress.com/*
// @grant          none
// ==/UserScript==

function wrapper(plugin_info) {
  if(typeof window.plugin !== 'function') window.plugin = function(){};

  window.plugin.anomalySimulator = {
    active: false,
    phase: 1,
    zones: [], // {layer: L.Layer, active: bool, phase: int}
    sites: [], // {id:string, name:string, latLng:L.LatLng, active:bool, phase:int, marker:L.Marker}

    setup: function() {
      // Botón activar/desactivar simulación
      var $toggle = $('<a>')
        .attr('id','anomaly-sim-toggle')
        .attr('title','Activar / Desactivar simulación anomalía')
        .text('Anomaly: off')
        .click(function() {
          window.plugin.anomalySimulator.active = !window.plugin.anomalySimulator.active;
          $(this).text(window.plugin.anomalySimulator.active ? 'Anomaly: on' : 'Anomaly: off');
          window.plugin.anomalySimulator.refresh();
        })
        .appendTo('#toolbox');

      // Botón agregar zona desde Draw Tools
      var $addZone = $('<a>')
        .attr('title','Agregar zona desde Draw Tools')
        .text('Add Zone')
        .click(function() {
          if(!window.plugin.drawTools || !window.plugin.drawTools.drawnItems) {
            alert('Draw Tools no está activo o cargado.');
            return;
          }
          var layers = window.plugin.drawTools.drawnItems._layers;
          var lastLayer = null;
          for(var k in layers) lastLayer = layers[k];
          if(!lastLayer) {
            alert('No hay zona creada en Draw Tools.');
            return;
          }
          window.plugin.anomalySimulator.zones.push({
            layer: lastLayer,
            active: true,
            phase: window.plugin.anomalySimulator.phase
          });
          alert('Zona agregada.');
          window.plugin.anomalySimulator.refresh();
        })
        .appendTo('#toolbox');

      // Botón agregar sitio manual
      var $addSite = $('<a>')
        .attr('title','Agregar sitio manual')
        .text('Add Site')
        .click(function() {
          var name = prompt('Nombre sitio:');
          if(!name) return alert('Nombre inválido.');
          var lat = parseFloat(prompt('Latitud:'));
          var lng = parseFloat(prompt('Longitud:'));
          if(isNaN(lat) || isNaN(lng)) return alert('Coordenadas inválidas.');
          window.plugin.anomalySimulator.sites.push({
            id: 'manual_' + Date.now(),
            name: name,
            latLng: L.latLng(lat,lng),
            active: true,
            phase: window.plugin.anomalySimulator.phase,
            marker: null
          });
          window.plugin.anomalySimulator.refresh();
        })
        .appendTo('#toolbox');

      // Selector fase
      var $phaseLabel = $('<label>').text('Phase: ');
      var $phaseSelect = $('<select>')
        .attr('title','Seleccionar fase de simulación')
        .attr('id','anomaly-sim-phase-select')
        .append(
          $('<option>').val(1).text('1'),
          $('<option>').val(2).text('2'),
          $('<option>').val(3).text('3')
        )
        .val(window.plugin.anomalySimulator.phase)
        .change(function() {
          window.plugin.anomalySimulator.phase = parseInt($(this).val());
          window.plugin.anomalySimulator.refresh();
        });

      $('#toolbox').append($phaseLabel).append($phaseSelect);

      // Botón listar bookmarks
      var $listBms = $('<a>')
        .attr('title','Listar bookmarks')
        .text('List Bookmarks')
        .click(function() {
          if(!window.plugin.bookmarks) {
            alert('Bookmarks plugin no está activo.');
            return;
          }
          var bms = window.plugin.bookmarks.bookmarks || [];
          if(bms.length === 0) {
            alert('No hay bookmarks.');
            return;
          }
          var msg = 'Bookmarks:\n';
          bms.forEach(function(bm,i){
            msg += (i+1) + '. ' + bm.name + ` (${bm.latLng.lat.toFixed(5)},${bm.latLng.lng.toFixed(5)})\n`;
          });
          alert(msg);
        })
        .appendTo('#toolbox');

      // Botón exportar configuración
      var $exportBtn = $('<a>')
        .attr('title','Exportar configuración JSON')
        .text('Export Config')
        .click(function() {
          var exportData = {
            active: window.plugin.anomalySimulator.active,
            phase: window.plugin.anomalySimulator.phase,
            zones: window.plugin.anomalySimulator.zones.map(function(z) {
              return {
                geojson: z.layer.toGeoJSON(),
                active: z.active,
                phase: z.phase
              };
            }),
            sites: window.plugin.anomalySimulator.sites.map(function(s) {
              return {
                id: s.id,
                name: s.name,
                latLng: s.latLng,
                active: s.active,
                phase: s.phase
              };
            })
          };
          var jsonStr = JSON.stringify(exportData,null,2);
          prompt('Copiar configuración JSON:', jsonStr);
        })
        .appendTo('#toolbox');

      // Botón importar configuración
      var $importBtn = $('<a>')
        .attr('title','Importar configuración JSON')
        .text('Import Config')
        .click(function() {
          var jsonStr = prompt('Pegar configuración JSON:');
          if(!jsonStr) return;
          try {
            var data = JSON.parse(jsonStr);

            // Limpiar capas actuales
            window.plugin.anomalySimulator.zones.forEach(function(z){
              if(window.map.hasLayer(z.layer)) window.map.removeLayer(z.layer);
            });
            window.plugin.anomalySimulator.sites.forEach(function(s){
              if(s.marker) {
                window.map.removeLayer(s.marker);
                s.marker = null;
              }
            });

            window.plugin.anomalySimulator.zones = [];
            window.plugin.anomalySimulator.sites = [];

            data.zones.forEach(function(z){
              var layer = L.geoJSON(z.geojson).getLayers()[0];
              window.plugin.anomalySimulator.zones.push({
                layer: layer,
                active: z.active,
                phase: z.phase
              });
            });
            data.sites.forEach(function(s){
              window.plugin.anomalySimulator.sites.push({
                id: s.id,
                name: s.name,
                latLng: L.latLng(s.latLng.lat, s.latLng.lng),
                active: s.active,
                phase: s.phase,
                marker: null
              });
            });

            window.plugin.anomalySimulator.phase = data.phase || 1;
            window.plugin.anomalySimulator.active = data.active || false;

            $('#anomaly-sim-toggle').text(window.plugin.anomalySimulator.active ? 'Anomaly: on' : 'Anomaly: off');
            $('#anomaly-sim-phase-select').val(window.plugin.anomalySimulator.phase);

            window.plugin.anomalySimulator.refresh();
            alert('Configuración importada correctamente.');
          } catch(e) {
            alert('Error al importar configuración JSON: ' + e);
          }
        })
        .appendTo('#toolbox');

      window.addHook('mapDataRefreshEnd', window.plugin.anomalySimulator.refresh);
    },

    refresh: function() {
      // Limpiar capas previas
      window.plugin.anomalySimulator.zones.forEach(function(z){
        if(window.map.hasLayer(z.layer)) window.map.removeLayer(z.layer);
      });
      window.plugin.anomalySimulator.sites.forEach(function(s){
        if(s.marker) {
          window.map.removeLayer(s.marker);
          s.marker = null;
        }
      });

      if(!window.plugin.anomalySimulator.active) return;

      // Dibujar zonas activas y fase actual
      window.plugin.anomalySimulator.zones.forEach(function(z){
        if(z.active && z.phase === window.plugin.anomalySimulator.phase) {
          if(z.layer.setStyle) z.layer.setStyle({color:'red', fillOpacity:0.3, weight:3});
          z.layer.addTo(window.map);
        }
      });

      // Dibujar sitios activos y fase actual
      window.plugin.anomalySimulator.sites.forEach(function(s){
        if(s.active && s.phase === window.plugin.anomalySimulator.phase) {
          var marker = L.circleMarker(s.latLng, {
            color: 'red',
            fillColor: 'red',
            fillOpacity: 0.8,
            radius: 8
          }).bindPopup('Site: ' + s.name).addTo(window.map);
          s.marker = marker;
        }
      });
    }
  };

  var setup = window.plugin.anomalySimulator.setup;
  setup.info = plugin_info;

  if(window.iitcLoaded) {
    setup();
  } else {
    window.addHook('iitcLoaded', setup);
  }
}

var plugin_info = {};
plugin_info.script = document.currentScript ? document.currentScript.src : '';
plugin_info.version = '1.1';

var script = document.createElement('script');
script.appendChild(document.createTextNode('('+ wrapper +')('+JSON.stringify(plugin_info)+');'));
(document.body || document.head || document.documentElement).appendChild(script);
