// ==UserScript==
// @id             iitc_plugin_anomaly_simulator
// @name           Anomaly Simulator
// @category       Misc
// @version        0.1.0
// @description    Simula anomalías con zonas y sitios, compatible con Draw Tools y Bookmarks
// @author         ShadowVcL
// @match          *://intel.ingress.com/*
// @grant          none
// ==/UserScript==

function wrapper(plugin_info) {
  if(typeof window.plugin !== 'function') window.plugin = function(){};

  window.plugin.anomalySimulator = {
    active: false,
    phase: 1,
    zones: [],   // {layer: L.Layer, active: bool, phase: int}
    sites: [],   // {id: string, name: string, latLng: L.LatLng, active: bool, phase: int, marker: L.Marker}

    setup: function() {
      // Añadir botón para activar/desactivar simulación
      var toggleBtn = $('<a>')
        .text('Anomaly: off')
        .attr('title', 'Toggle Anomaly Simulator')
        .attr('id', 'anomaly-simulator-toggle')
        .click(function() {
          window.plugin.anomalySimulator.active = !window.plugin.anomalySimulator.active;
          $(this).text(window.plugin.anomalySimulator.active ? 'Anomaly: on' : 'Anomaly: off');
          window.plugin.anomalySimulator.refresh();
        })
        .appendTo('#toolbox');

      // Botón para agregar zona desde Draw Tools
      var addZoneBtn = $('<a>')
        .text('Add Zone')
        .attr('title', 'Add zone from Draw Tools')
        .click(function() {
          if(!window.plugin.drawTools) {
            alert('Draw Tools plugin not loaded!');
            return;
          }
          var drawnItems = window.plugin.drawTools.drawnItems._layers;
          var lastLayer = null;
          for(var k in drawnItems) lastLayer = drawnItems[k];
          if(!lastLayer) {
            alert('No zone drawn in Draw Tools!');
            return;
          }
          window.plugin.anomalySimulator.zones.push({
            layer: lastLayer,
            active: true,
            phase: window.plugin.anomalySimulator.phase
          });
          alert('Zone added to anomaly simulator');
          window.plugin.anomalySimulator.refresh();
        })
        .appendTo('#toolbox');

      // Botón para agregar sitio manualmente
      var addSiteBtn = $('<a>')
        .text('Add Site')
        .attr('title', 'Add a control site manually')
        .click(function() {
          var name = prompt('Enter site name:');
          if(!name) return alert('Invalid name');
          var lat = parseFloat(prompt('Enter latitude:'));
          var lng = parseFloat(prompt('Enter longitude:'));
          if(isNaN(lat) || isNaN(lng)) return alert('Invalid coordinates');
          window.plugin.anomalySimulator.sites.push({
            id: 'manual_' + Date.now(),
            name: name,
            latLng: L.latLng(lat,lng),
            active: true,
            phase: window.plugin.anomalySimulator.phase,
            marker: null
          });
          window.plugin.anomalySimulator.refresh();
        })
        .appendTo('#toolbox');

      // Selector fase
      var phaseSelect = $('<select>')
        .attr('title', 'Select simulation phase')
        .attr('id', 'anomaly-phase-select')
        .append(
          $('<option>').val(1).text('Phase 1'),
          $('<option>').val(2).text('Phase 2'),
          $('<option>').val(3).text('Phase 3')
        )
        .val(window.plugin.anomalySimulator.phase)
        .change(function() {
          window.plugin.anomalySimulator.phase = parseInt($(this).val());
          window.plugin.anomalySimulator.refresh();
        })
        .appendTo('#toolbox');

      $('<label>')
        .text(' Phase: ')
        .prependTo(phaseSelect);

      // Botón para listar bookmarks
      var listBookmarksBtn = $('<a>')
        .text('List Bookmarks')
        .attr('title', 'List current bookmarks')
        .click(function() {
          if(!window.plugin.bookmarks) {
            alert('Bookmarks plugin not loaded!');
            return;
          }
          var bms = window.plugin.bookmarks.bookmarks;
          if(!bms || bms.length === 0) {
            alert('No bookmarks saved.');
            return;
          }
          var msg = 'Bookmarks:\n';
          bms.forEach(function(bm,i){
            msg += (i+1) + '. ' + bm.name + ` (${bm.latLng.lat.toFixed(5)},${bm.latLng.lng.toFixed(5)})\n`;
          });
          alert(msg);
        })
        .appendTo('#toolbox');

      // Botón exportar configuración JSON
      var exportBtn = $('<a>')
        .text('Export Config')
        .attr('title', 'Export anomaly configuration JSON')
        .click(function() {
          var exportData = {
            active: window.plugin.anomalySimulator.active,
            phase: window.plugin.anomalySimulator.phase,
            zones: window.plugin.anomalySimulator.zones.map(function(z){
              return {
                geojson: z.layer.toGeoJSON(),
                active: z.active,
                phase: z.phase
              };
            }),
            sites: window.plugin.anomalySimulator.sites.map(function(s){
              return {
                id: s.id,
                name: s.name,
                latLng: s.latLng,
                active: s.active,
                phase: s.phase
              };
            })
          };
          var jsonStr = JSON.stringif
